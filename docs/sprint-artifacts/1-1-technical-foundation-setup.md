# Story 1.1: Technical Foundation Setup

**Status:** done

## Story

As a **developer**,  
I want the application to have TanStack Query, Zustand, and supporting libraries configured,  
So that all future features have a consistent state management foundation.

## Acceptance Criteria

### AC1: Dependencies Installed ✅
**Given** the billie-crm codebase  
**When** I run `pnpm install`  
**Then** the following packages are installed:
- `@tanstack/react-query` (v5) ✅
- `@tanstack/react-query-devtools` (v5, dev only) ✅
- `zustand` (v4 or v5) ✅
- `cmdk` (v1) ✅
- `sonner` (v1) ✅
- `zod` (v3) ✅
- `nanoid` ✅
- `react-hook-form` ✅
- `@hookform/resolvers` ✅

### AC2: QueryClientProvider Configured ✅
**Given** the application starts  
**When** any page loads  
**Then** the QueryClientProvider wraps the application with:
- `staleTime: 10_000` (10 seconds) ✅
- `refetchOnWindowFocus: true` ✅
- `retry: 2` ✅

### AC3: Toast Notifications Available ✅
**Given** the application starts  
**When** any page loads  
**Then** the Toaster (sonner) component is rendered with position `top-right` ✅

### AC4: Optimistic Store Available ✅
**Given** the `src/stores` directory  
**When** I import from `@/stores`  
**Then** I can access:
- `useOptimisticStore` with `pendingByAccount` Map ✅
- `MutationStage` type (`optimistic` | `submitted` | `confirmed` | `failed`) ✅
- Actions: `setPending`, `setStage`, `clearPending` ✅
- Selectors: `getPendingForAccount`, `getPendingAmount`, `hasPendingMutations` ✅

### AC5: UI Store Available (Read-Only Mode Stub) ✅
**Given** the `src/stores` directory  
**When** I import from `@/stores`  
**Then** I can access `useUIStore` with `readOnlyMode` boolean and `setReadOnlyMode` action ✅

### AC6: Error Messages Centralized ✅
**Given** the `src/lib/errors` directory  
**When** I import `ERROR_MESSAGES` from `@/lib/errors/messages`  
**Then** I get a typed map including:
- `INSUFFICIENT_PRIVILEGES` ✅
- `VERSION_CONFLICT` ✅
- `LEDGER_UNAVAILABLE` ✅
- `VALIDATION_ERROR` ✅
- `ACCOUNT_NOT_FOUND` ✅
- `SELF_APPROVAL_FORBIDDEN` ✅
- `NETWORK_ERROR` ✅
- `UNKNOWN_ERROR` ✅

### AC7: Idempotency Utility Available ✅
**Given** the `src/lib/utils` directory  
**When** I import `generateIdempotencyKey` from `@/lib/utils/idempotency`  
**Then** the function generates keys in format: `{userId}-{action}-{timestamp}-{random8chars}` ✅

---

## Tasks / Subtasks

- [x] **Task 1: Install Dependencies** (AC: 1)
  - [x] Run `pnpm add @tanstack/react-query zustand cmdk sonner zod nanoid react-hook-form @hookform/resolvers`
  - [x] Run `pnpm add -D @tanstack/react-query-devtools`
  - [x] Verify package.json updated

- [x] **Task 2: Create Provider Infrastructure** (AC: 2, 3)
  - [x] Create `src/providers/query-client.tsx` with SSR-safe QueryClientProvider
  - [x] Create `src/providers/index.tsx` with Providers wrapper + Toaster + DevTools
  - [x] Register providers in `payload.config.ts` via `admin.components.providers`

- [x] **Task 3: Create Stores** (AC: 4, 5)
  - [x] Create `src/stores/optimistic.ts`
  - [x] Create `src/stores/ui.ts`
  - [x] Create `src/stores/index.ts` barrel export
  - [x] Create `src/types/mutation.ts`
  - [x] Create `src/types/index.ts` barrel export

- [x] **Task 4: Create Error Handling** (AC: 6)
  - [x] Create `src/lib/errors/messages.ts`
  - [x] Create `src/lib/errors/index.ts` barrel export

- [x] **Task 5: Create Utilities** (AC: 7)
  - [x] Create `src/lib/utils/idempotency.ts`
  - [x] Create `src/lib/utils/index.ts` barrel export

- [x] **Task 6: Write Tests**
  - [x] Create `tests/unit/stores/` directory
  - [x] Create `tests/unit/lib/` directory
  - [x] Write `tests/unit/stores/optimistic.test.ts`
  - [x] Write `tests/unit/lib/idempotency.test.ts`

---

## Dev Notes

### Provider Integration (CRITICAL)

⚠️ **DO NOT modify `src/app/(payload)/layout.tsx`** - it's auto-generated by Payload and will be overwritten.

**Correct approach:** Use Payload's `admin.components.providers` configuration:

```typescript
// payload.config.ts
import { buildConfig } from 'payload'

export default buildConfig({
  // ... existing config
  admin: {
    // ... existing admin config
    components: {
      providers: ['@/providers'],  // Register our providers
    },
  },
})
```

### QueryClientProvider (SSR-Safe Pattern)

```typescript
// src/providers/query-client.tsx
'use client'

import { QueryClient, QueryClientProvider as TanStackProvider } from '@tanstack/react-query'
import { useState } from 'react'

export const QueryClientProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  // Create QueryClient inside useState to prevent hydration mismatch
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 10_000,
        refetchOnWindowFocus: true,
        retry: 2,
      },
    },
  }))

  return <TanStackProvider client={queryClient}>{children}</TanStackProvider>
}
```

### Providers Wrapper

```typescript
// src/providers/index.tsx
'use client'

import { QueryClientProvider } from './query-client'
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'
import { Toaster } from 'sonner'

export const Providers: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  return (
    <QueryClientProvider>
      {children}
      <Toaster position="top-right" richColors />
      {process.env.NODE_ENV === 'development' && (
        <ReactQueryDevtools initialIsOpen={false} />
      )}
    </QueryClientProvider>
  )
}

// Default export required for Payload's provider registration
export default Providers
```

---

## References

- [docs/architecture.md] - State management, query configuration
- [docs/project_context.md] - Code style, testing rules
- [docs/epics.md#Story 1.1] - Acceptance criteria

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (Anthropic)

### Completion Notes
- All 7 acceptance criteria satisfied
- 12 new tests added (7 for optimistic store, 5 for idempotency)
- All 114 tests pass (including 12 new tests)
- Next.js build compiles successfully
- Lint now runs successfully (`pnpm run lint`) after adding missing ESLint dependency
- Providers registered via Payload's `admin.components.providers` (not direct layout modification)
- Import map regenerated with `pnpm run generate:importmap`

### Files Created
1. `src/providers/query-client.tsx` - SSR-safe QueryClientProvider
2. `src/providers/index.tsx` - Providers wrapper with Toaster + DevTools
3. `src/stores/optimistic.ts` - Zustand optimistic mutations store
4. `src/stores/ui.ts` - UI state store (readOnlyMode stub)
5. `src/stores/index.ts` - Stores barrel export
6. `src/types/mutation.ts` - MutationStage and PendingMutation types
7. `src/types/index.ts` - Types barrel export
8. `src/lib/errors/messages.ts` - ERROR_MESSAGES constant
9. `src/lib/errors/index.ts` - Errors barrel export
10. `src/lib/utils/idempotency.ts` - generateIdempotencyKey function
11. `src/lib/utils/index.ts` - Utils barrel export
12. `tests/unit/stores/optimistic.test.ts` - 7 unit tests
13. `tests/unit/lib/idempotency.test.ts` - 5 unit tests

### Files Modified
1. `package.json` - Added dependencies (incl. `@eslint/eslintrc`)
2. `pnpm-lock.yaml` - Updated lockfile
3. `src/payload.config.ts` - Added `admin.components.providers`
4. `src/app/(payload)/admin/importMap.js` - Auto-regenerated by Payload
5. `src/components/LoanAccountServicing/WriteOffModal.tsx` - Fix ESLint `react/no-unescaped-entities`
6. `src/providers/index.tsx` - Document default export exception for Payload provider registration

### Change Log
- 2025-12-11: Initial implementation of Story 1.1 - Technical Foundation Setup
- 2025-12-11: Senior code review fixes (lint + minor compliance adjustments)

---

## Senior Developer Review (AI)

**Reviewer:** Rohan  
**Date:** 2025-12-11  
**Outcome:** Approve

### Findings & Resolutions

- [x] **HIGH**: Repo lint was failing due to missing `@eslint/eslintrc` dependency; added it and confirmed `pnpm run lint` succeeds.
- [x] **MEDIUM**: Story status normalized to align with sprint state machine (`done` / `review` / etc.).
- [x] **MEDIUM**: Recorded senior review outcome and resolutions in-story for traceability.
- [x] **LOW**: Documented default export exception for `@/providers` as required by Payload import map.
