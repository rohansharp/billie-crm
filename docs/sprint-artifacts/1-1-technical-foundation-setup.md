# Story 1.1: Technical Foundation Setup

**Status:** ready-for-dev

## Story

As a **developer**,  
I want the application to have TanStack Query, Zustand, and supporting libraries configured,  
So that all future features have a consistent state management foundation.

## Acceptance Criteria

### AC1: Dependencies Installed
**Given** the billie-crm codebase  
**When** I run `pnpm install`  
**Then** the following packages are installed:
- `@tanstack/react-query` (v5)
- `@tanstack/react-query-devtools` (v5, dev only)
- `zustand` (v4 or v5)
- `cmdk` (v1)
- `sonner` (v1)
- `zod` (v3)
- `nanoid`
- `react-hook-form`
- `@hookform/resolvers`

### AC2: QueryClientProvider Configured
**Given** the application starts  
**When** any page loads  
**Then** the QueryClientProvider wraps the application with:
- `staleTime: 10_000` (10 seconds)
- `refetchOnWindowFocus: true`
- `retry: 2`

### AC3: Toast Notifications Available
**Given** the application starts  
**When** any page loads  
**Then** the Toaster (sonner) component is rendered with position `top-right`

### AC4: Optimistic Store Available
**Given** the `src/stores` directory  
**When** I import from `@/stores`  
**Then** I can access:
- `useOptimisticStore` with `pendingByAccount` Map
- `MutationStage` type (`optimistic` | `submitted` | `confirmed` | `failed`)
- Actions: `setPending`, `setStage`, `clearPending`
- Selectors: `getPendingForAccount`, `getPendingAmount`, `hasPendingMutations`

### AC5: UI Store Available (Read-Only Mode Stub)
**Given** the `src/stores` directory  
**When** I import from `@/stores`  
**Then** I can access `useUIStore` with `readOnlyMode` boolean and `setReadOnlyMode` action

### AC6: Error Messages Centralized
**Given** the `src/lib/errors` directory  
**When** I import `ERROR_MESSAGES` from `@/lib/errors/messages`  
**Then** I get a typed map including:
- `INSUFFICIENT_PRIVILEGES`
- `VERSION_CONFLICT`
- `LEDGER_UNAVAILABLE`
- `VALIDATION_ERROR`
- `ACCOUNT_NOT_FOUND`
- `SELF_APPROVAL_FORBIDDEN`
- `NETWORK_ERROR`
- `UNKNOWN_ERROR`

### AC7: Idempotency Utility Available
**Given** the `src/lib/utils` directory  
**When** I import `generateIdempotencyKey` from `@/lib/utils/idempotency`  
**Then** the function generates keys in format: `{userId}-{action}-{timestamp}-{random8chars}`

---

## Tasks / Subtasks

- [ ] **Task 1: Install Dependencies** (AC: 1)
  - [ ] Run `pnpm add @tanstack/react-query zustand cmdk sonner zod nanoid react-hook-form @hookform/resolvers`
  - [ ] Run `pnpm add -D @tanstack/react-query-devtools`
  - [ ] Verify package.json updated

- [ ] **Task 2: Create Provider Infrastructure** (AC: 2, 3)
  - [ ] Create `src/providers/query-client.tsx` with SSR-safe QueryClientProvider
  - [ ] Create `src/providers/index.tsx` with Providers wrapper + Toaster + DevTools
  - [ ] Register providers in `payload.config.ts` via `admin.components.providers`

- [ ] **Task 3: Create Stores** (AC: 4, 5)
  - [ ] Create `src/stores/optimistic.ts`
  - [ ] Create `src/stores/ui.ts`
  - [ ] Create `src/stores/index.ts` barrel export
  - [ ] Create `src/types/mutation.ts`
  - [ ] Create `src/types/index.ts` barrel export

- [ ] **Task 4: Create Error Handling** (AC: 6)
  - [ ] Create `src/lib/errors/messages.ts`
  - [ ] Create `src/lib/errors/index.ts` barrel export

- [ ] **Task 5: Create Utilities** (AC: 7)
  - [ ] Create `src/lib/utils/idempotency.ts`
  - [ ] Create `src/lib/utils/index.ts` barrel export

- [ ] **Task 6: Write Tests**
  - [ ] Create `tests/unit/stores/` directory
  - [ ] Create `tests/unit/lib/` directory
  - [ ] Write `tests/unit/stores/optimistic.test.ts`
  - [ ] Write `tests/unit/lib/idempotency.test.ts`

---

## Dev Notes

### Provider Integration (CRITICAL)

⚠️ **DO NOT modify `src/app/(payload)/layout.tsx`** - it's auto-generated by Payload and will be overwritten.

**Correct approach:** Use Payload's `admin.components.providers` configuration:

```typescript
// payload.config.ts
import { buildConfig } from 'payload'

export default buildConfig({
  // ... existing config
  admin: {
    // ... existing admin config
    components: {
      providers: ['@/providers'],  // Register our providers
    },
  },
})
```

### QueryClientProvider (SSR-Safe Pattern)

```typescript
// src/providers/query-client.tsx
'use client'

import { QueryClient, QueryClientProvider as TanStackProvider } from '@tanstack/react-query'
import { useState } from 'react'

export const QueryClientProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  // Create QueryClient inside useState to prevent hydration mismatch
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 10_000,
        refetchOnWindowFocus: true,
        retry: 2,
      },
    },
  }))

  return <TanStackProvider client={queryClient}>{children}</TanStackProvider>
}
```

### Providers Wrapper

```typescript
// src/providers/index.tsx
'use client'

import { QueryClientProvider } from './query-client'
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'
import { Toaster } from 'sonner'

export const Providers: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  return (
    <QueryClientProvider>
      {children}
      <Toaster position="top-right" richColors />
      {process.env.NODE_ENV === 'development' && (
        <ReactQueryDevtools initialIsOpen={false} />
      )}
    </QueryClientProvider>
  )
}

// Default export required for Payload's provider registration
export default Providers
```

### Types

```typescript
// src/types/mutation.ts
export type MutationStage = 'optimistic' | 'submitted' | 'confirmed' | 'failed'

export interface PendingMutation {
  id: string
  accountId: string
  action: string
  stage: MutationStage
  amount?: number
  createdAt: number
  error?: string
}
```

### Optimistic Store Interface

```typescript
// src/stores/optimistic.ts
'use client'

import { create } from 'zustand'
import type { PendingMutation, MutationStage } from '@/types/mutation'

interface OptimisticState {
  pendingByAccount: Map<string, Map<string, PendingMutation>>
  setPending: (accountId: string, mutation: PendingMutation) => void
  setStage: (accountId: string, mutationId: string, stage: MutationStage, error?: string) => void
  clearPending: (accountId: string, mutationId: string) => void
  getPendingForAccount: (accountId: string) => PendingMutation[]
  getPendingAmount: (accountId: string) => number
  hasPendingMutations: (accountId: string) => boolean
}

// Implementation: Create store following this interface
// Key patterns:
// - Use Map cloning for immutability: new Map(state.pendingByAccount)
// - Filter out 'failed' mutations in getPendingAmount
// - Return empty array if no mutations for account
```

### UI Store

```typescript
// src/stores/ui.ts
'use client'

import { create } from 'zustand'

interface UIState {
  readOnlyMode: boolean
  setReadOnlyMode: (value: boolean) => void
}

export const useUIStore = create<UIState>((set) => ({
  readOnlyMode: false,
  setReadOnlyMode: (value) => set({ readOnlyMode: value }),
}))
```

### Error Messages

```typescript
// src/lib/errors/messages.ts
export const ERROR_MESSAGES = {
  INSUFFICIENT_PRIVILEGES: 'You do not have permission to perform this action.',
  VERSION_CONFLICT: 'This record was modified by another user. Please refresh and try again.',
  LEDGER_UNAVAILABLE: 'The ledger service is currently unavailable. Please try again later.',
  VALIDATION_ERROR: 'Please check your input and try again.',
  ACCOUNT_NOT_FOUND: 'The requested account could not be found.',
  SELF_APPROVAL_FORBIDDEN: 'You cannot approve your own request.',
  NETWORK_ERROR: 'A network error occurred. Please check your connection.',
  UNKNOWN_ERROR: 'An unexpected error occurred. Please try again or contact support.',
} as const

export type ErrorCode = keyof typeof ERROR_MESSAGES
```

### Idempotency Utility

```typescript
// src/lib/utils/idempotency.ts
import { nanoid } from 'nanoid'

export function generateIdempotencyKey(userId: string, action: string): string {
  return `${userId}-${action}-${Date.now()}-${nanoid(8)}`
}
```

### Barrel Exports

```typescript
// src/stores/index.ts
export { useOptimisticStore } from './optimistic'
export { useUIStore } from './ui'

// src/types/index.ts
export type { MutationStage, PendingMutation } from './mutation'

// src/lib/errors/index.ts
export { ERROR_MESSAGES, type ErrorCode } from './messages'

// src/lib/utils/index.ts
export { generateIdempotencyKey } from './idempotency'
```

---

## Testing Requirements

### Test File: `tests/unit/stores/optimistic.test.ts`

```typescript
import { describe, test, expect, beforeEach } from 'vitest'
import { useOptimisticStore } from '@/stores/optimistic'

describe('useOptimisticStore', () => {
  beforeEach(() => {
    useOptimisticStore.setState({ pendingByAccount: new Map() })
  })

  test('setPending adds mutation to account', () => {
    const { setPending, getPendingForAccount } = useOptimisticStore.getState()
    
    setPending('acc-123', {
      id: 'mut-1',
      accountId: 'acc-123',
      action: 'waive-fee',
      stage: 'optimistic',
      amount: -50,
      createdAt: Date.now(),
    })
    
    expect(getPendingForAccount('acc-123')).toHaveLength(1)
  })

  test('setStage updates mutation stage', () => {
    const { setPending, setStage, getPendingForAccount } = useOptimisticStore.getState()
    
    setPending('acc-123', {
      id: 'mut-1',
      accountId: 'acc-123',
      action: 'waive-fee',
      stage: 'optimistic',
      createdAt: Date.now(),
    })
    
    setStage('acc-123', 'mut-1', 'confirmed')
    
    expect(getPendingForAccount('acc-123')[0].stage).toBe('confirmed')
  })

  test('clearPending removes mutation', () => {
    const { setPending, clearPending, getPendingForAccount } = useOptimisticStore.getState()
    
    setPending('acc-123', {
      id: 'mut-1',
      accountId: 'acc-123',
      action: 'waive-fee',
      stage: 'optimistic',
      createdAt: Date.now(),
    })
    
    clearPending('acc-123', 'mut-1')
    
    expect(getPendingForAccount('acc-123')).toHaveLength(0)
  })

  test('getPendingAmount excludes failed mutations', () => {
    const { setPending, setStage, getPendingAmount } = useOptimisticStore.getState()
    
    setPending('acc-123', { id: 'mut-1', accountId: 'acc-123', action: 'fee', stage: 'optimistic', amount: -50, createdAt: Date.now() })
    setPending('acc-123', { id: 'mut-2', accountId: 'acc-123', action: 'fee', stage: 'optimistic', amount: -30, createdAt: Date.now() })
    
    setStage('acc-123', 'mut-2', 'failed')
    
    expect(getPendingAmount('acc-123')).toBe(-50)
  })

  test('hasPendingMutations returns correct boolean', () => {
    const { setPending, hasPendingMutations } = useOptimisticStore.getState()
    
    expect(hasPendingMutations('acc-123')).toBe(false)
    
    setPending('acc-123', { id: 'mut-1', accountId: 'acc-123', action: 'fee', stage: 'optimistic', createdAt: Date.now() })
    
    expect(hasPendingMutations('acc-123')).toBe(true)
  })
})
```

### Test File: `tests/unit/lib/idempotency.test.ts`

```typescript
import { describe, test, expect } from 'vitest'
import { generateIdempotencyKey } from '@/lib/utils/idempotency'

describe('generateIdempotencyKey', () => {
  test('generates unique keys on repeated calls', () => {
    const key1 = generateIdempotencyKey('user-1', 'waive-fee')
    const key2 = generateIdempotencyKey('user-1', 'waive-fee')
    
    expect(key1).not.toBe(key2)
  })

  test('key format matches {userId}-{action}-{timestamp}-{random}', () => {
    const key = generateIdempotencyKey('user-123', 'record-repayment')
    
    expect(key).toMatch(/^user-123-record-repayment-\d+-[a-zA-Z0-9_-]{8}$/)
  })

  test('includes all components', () => {
    const key = generateIdempotencyKey('abc', 'xyz')
    const parts = key.split('-')
    
    expect(parts[0]).toBe('abc')
    expect(parts[1]).toBe('xyz')
    expect(parts[2]).toMatch(/^\d+$/)
    expect(parts[3]).toHaveLength(8)
  })
})
```

---

## File Structure

```
src/
├── providers/
│   ├── index.tsx           # Providers wrapper (default export for Payload)
│   └── query-client.tsx    # SSR-safe QueryClientProvider
├── stores/
│   ├── index.ts            # Barrel: useOptimisticStore, useUIStore
│   ├── optimistic.ts       # Pending mutations store
│   └── ui.ts               # UI state (readOnlyMode)
├── lib/
│   ├── errors/
│   │   ├── index.ts        # Barrel: ERROR_MESSAGES, ErrorCode
│   │   └── messages.ts     # Error code map
│   └── utils/
│       ├── index.ts        # Barrel: generateIdempotencyKey
│       └── idempotency.ts  # Key generation
└── types/
    ├── index.ts            # Barrel: MutationStage, PendingMutation
    └── mutation.ts         # Type definitions

tests/unit/
├── stores/
│   └── optimistic.test.ts
└── lib/
    └── idempotency.test.ts
```

---

## Files to Modify

1. **`package.json`** - Dependencies added via pnpm
2. **`payload.config.ts`** - Add `admin.components.providers: ['@/providers']`

---

## References

- [docs/architecture.md] - State management, query configuration
- [docs/project_context.md] - Code style, testing rules
- [docs/epics.md#Story 1.1] - Acceptance criteria

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev agent_

### Completion Notes
_To be filled after implementation_

### Files Created
_To be filled after implementation_
