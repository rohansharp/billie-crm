# Test/Staging Dockerfile - runs both Next.js frontend (HTTP) and Python event processor
# Use this for deployments behind a reverse proxy (e.g., Traefik, Nginx) that handles SSL
FROM node:22-alpine

# Install Python and dependencies
RUN apk add --no-cache \
    python3 \
    py3-pip \
    git \
    bash

# Create app directory
WORKDIR /app

# Install pnpm (disable strict mode to work around corepack signature verification bug in Node 22)
ENV COREPACK_ENABLE_STRICT=0
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy package files for Node.js
COPY package.json pnpm-lock.yaml ./

# Install Node.js dependencies
RUN pnpm install --frozen-lockfile

# Copy Python requirements and install base dependencies (without SDK lines)
COPY event-processor/requirements.txt ./event-processor/
RUN grep -v "git+https" event-processor/requirements.txt > /tmp/base-requirements.txt && \
    pip3 install --no-cache-dir --break-system-packages -r /tmp/base-requirements.txt

# Install Billie SDKs from requirements.txt (requires GITHUB_TOKEN at build time)
ARG GITHUB_TOKEN
RUN if [ -n "$GITHUB_TOKEN" ]; then \
    git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/" && \
    grep "git+https.*billie-event-sdks" event-processor/requirements.txt | \
    sed "s/\${GITHUB_TOKEN}/${GITHUB_TOKEN}/g" | \
    xargs -I {} pip3 install --no-cache-dir --break-system-packages "{}"; \
    else echo "GITHUB_TOKEN not set, skipping SDK install"; fi

# Copy the rest of the application
COPY . .

# Build Next.js for production
RUN pnpm run build || (echo "Build failed!" && exit 1)
RUN test -f .next/BUILD_ID || (echo "Build ID file not found after build!" && exit 1)

# Set Python path for event processor
ENV PYTHONPATH=/app/event-processor/src
ENV NODE_ENV=production

EXPOSE 3000

# Start script runs both services (HTTP mode)
COPY start-http.sh /start-http.sh
RUN chmod +x /start-http.sh

CMD ["/start-http.sh"]
